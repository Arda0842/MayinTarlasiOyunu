using System;
using System.Drawing;
using System.Windows.Forms;
using System.Collections.Generic;

namespace MayinTarlasiOyunu
{
    public partial class Form1 : Form
    {
        private Button[,] buttons;
        private bool[,] mines;

        private int gridSize;
        private int mineCount;
        private int cellSize;
        private int openedCells = 0;
        private int time = 0;

        private const int topMargin = 100;
        private const int sideMargin = 20;

        private System.Windows.Forms.Timer gameTimer;
        private Label lblTime;
        private Label lblMines;
        private ComboBox cmbLevel;
        private Button btnRestart;

        private Random rnd = new Random();

        public Form1()
        {
            InitializeComponent();
            this.Text = "Minesweeper Pro";
            this.BackColor = Color.FromArgb(30, 30, 30);
            this.DoubleBuffered = true; 

            SetupUI();

            this.Resize += (s, e) => { if (gridSize > 0) ResizeGrid(); };
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            if (cmbLevel.SelectedIndex == -1) cmbLevel.SelectedIndex = 0;
        }

        void SetupUI()
        {
            Panel headerPanel = new Panel();
            headerPanel.Dock = DockStyle.Top;
            headerPanel.Height = 80;
            headerPanel.BackColor = Color.FromArgb(45, 45, 48);
            Controls.Add(headerPanel);

            cmbLevel = new ComboBox();
            cmbLevel.Items.AddRange(new string[] { "Kolay", "Orta", "Zor" });
            cmbLevel.SelectedIndex = 0;
            cmbLevel.Location = new Point(20, 25);
            cmbLevel.Width = 100;
            cmbLevel.DropDownStyle = ComboBoxStyle.DropDownList;
            cmbLevel.FlatStyle = FlatStyle.Flat;
            cmbLevel.Font = new Font("Segoe UI", 10);
            cmbLevel.SelectedIndexChanged += (s, e) => StartGame(cmbLevel!.SelectedItem!.ToString()!);
            headerPanel.Controls.Add(cmbLevel);

            btnRestart = new Button();
            btnRestart.Text = "Yeniden BaÅŸlat";
            btnRestart.Location = new Point(140, 23);
            btnRestart.Size = new Size(120, 32);
            btnRestart.FlatStyle = FlatStyle.Flat;
            btnRestart.BackColor = Color.SteelBlue;
            btnRestart.ForeColor = Color.White;
            btnRestart.Font = new Font("Segoe UI", 10, FontStyle.Bold);
            btnRestart.Click += (s, e) => StartGame(cmbLevel!.SelectedItem!.ToString()!);
            headerPanel.Controls.Add(btnRestart);

            lblTime = new Label();
            lblTime.Text = "SÃ¼re: 0";
            lblTime.Location = new Point(280, 28);
            lblTime.ForeColor = Color.White;
            lblTime.AutoSize = true;
            lblTime.Font = new Font("Segoe UI", 12, FontStyle.Bold);
            headerPanel.Controls.Add(lblTime);

            lblMines = new Label();
            lblMines.Text = "MayÄ±n: 0";
            lblMines.Location = new Point(380, 28);
            lblMines.ForeColor = Color.LightCoral;
            lblMines.AutoSize = true;
            lblMines.Font = new Font("Segoe UI", 12, FontStyle.Bold);
            headerPanel.Controls.Add(lblMines);

            gameTimer = new System.Windows.Forms.Timer();
            gameTimer.Interval = 1000;
            gameTimer.Tick += (s, e) =>
            {
                time++;
                lblTime.Text = "SÃ¼re: " + time;
            };
        }

        void StartGame(string level)
        {
            this.SuspendLayout(); 
            ClearGrid();

            openedCells = 0;
            time = 0;
            lblTime.Text = "SÃ¼re: 0";
            gameTimer.Stop();
            gameTimer.Start();

            switch (level)
            {
                case "Kolay":
                    gridSize = 10;   
                    mineCount = 12;
                    if (this.WindowState == FormWindowState.Maximized)
                        this.WindowState = FormWindowState.Normal;
                    this.Size = new Size(600, 700);
                    this.CenterToScreen();
                    break;

                case "Orta":
                    gridSize = 20;   
                    mineCount = 60;

                    if (this.WindowState == FormWindowState.Maximized)
                        this.WindowState = FormWindowState.Normal;
                    this.Size = new Size(900, 950);
                    this.CenterToScreen();
                    break;

                case "Zor":
                    gridSize = 30;   
                    mineCount = 160;
                    
                    this.WindowState = FormWindowState.Maximized;
                    break;
            }

            lblMines.Text = "MayÄ±n: " + mineCount;

            buttons = new Button[gridSize, gridSize];
            mines = new bool[gridSize, gridSize];

            CalculateCellSize();
            CreateGrid();
            PlaceMines();

            this.ResumeLayout(); 
        }

        void CalculateCellSize()
        {
            int usableWidth = ClientSize.Width - (sideMargin * 2);
            int usableHeight = ClientSize.Height - topMargin - 20;

            cellSize = Math.Min(usableWidth / gridSize, usableHeight / gridSize);

            if (cellSize < 22) cellSize = 22;

            if (cellSize > 50) cellSize = 50;
        }

        void CreateGrid()
        {
            int totalWidth = gridSize * cellSize;
            int totalHeight = gridSize * cellSize;

            int startX = (ClientSize.Width - totalWidth) / 2;
            if (startX < sideMargin) startX = sideMargin; 

            int startY = topMargin;

            for (int i = 0; i < gridSize; i++)
            {
                for (int j = 0; j < gridSize; j++)
                {
                    Button btn = new Button();
                    btn.Size = new Size(cellSize, cellSize);
                    btn.Location = new Point(startX + j * cellSize, startY + i * cellSize);
                    btn.Tag = $"{i},{j}";
                    btn.FlatStyle = FlatStyle.Flat;
                    btn.FlatAppearance.BorderSize = 1;
                    btn.FlatAppearance.BorderColor = Color.FromArgb(60, 60, 60);
                    btn.BackColor = Color.FromArgb(80, 80, 80); 

                    float fontSize = cellSize / 2.8f;
                    btn.Font = new Font("Segoe UI", fontSize, FontStyle.Bold);

                    btn.MouseDown += Cell_MouseDown!; 

                    Controls.Add(btn);
                    buttons[i, j] = btn;
                }
            }
        }

        void ResizeGrid()
        {
            if (buttons == null) return;
            this.SuspendLayout();

            CalculateCellSize();

            int totalWidth = gridSize * cellSize;
            int startX = (ClientSize.Width - totalWidth) / 2;
            if (startX < sideMargin) startX = sideMargin;
            int startY = topMargin;

            for (int i = 0; i < gridSize; i++)
            {
                for (int j = 0; j < gridSize; j++)
                {
                    if (buttons[i, j] != null)
                    {
                        buttons[i, j].Size = new Size(cellSize, cellSize);
                        buttons[i, j].Location = new Point(startX + j * cellSize, startY + i * cellSize);
                        buttons[i, j].Font = new Font("Segoe UI", cellSize / 2.8f, FontStyle.Bold);
                    }
                }
            }
            this.ResumeLayout();
        }

        void PlaceMines()
        {
            int placed = 0;
            while (placed < mineCount)
            {
                int r = rnd.Next(gridSize);
                int c = rnd.Next(gridSize);

                if (!mines[r, c])
                {
                    mines[r, c] = true;
                    placed++;
                }
            }
        }

        private void Cell_MouseDown(object sender, MouseEventArgs e)
        {
            Button btn = (sender as Button)!;
            if (!btn!.Enabled && btn.Text != "ðŸš©") return; 

            string[] pos = btn!.Tag!.ToString()!.Split(',');
            int r = int.Parse(pos[0]);
            int c = int.Parse(pos[1]);

            if (e.Button == MouseButtons.Right)
            {
                if (btn.Text == "ðŸš©")
                {
                    btn.Text = "";
                    btn.ForeColor = Color.White;
                }
                else if (btn.Enabled) 
                {
                    btn.Text = "ðŸš©";
                    btn.ForeColor = Color.Red;
                }
                return;
            }

            if (e.Button == MouseButtons.Left)
            {
                if (btn.Text == "ðŸš©") return; 

                if (mines[r, c])
                {
                    btn.BackColor = Color.Red;
                    btn.Text = "ðŸ’£";
                    ShowAllMines();
                    GameOver(false);
                }
                else
                {
                    OpenCell(r, c);
                    if (openedCells == (gridSize * gridSize) - mineCount)
                    {
                        GameOver(true);
                    }
                }
            }
        }

        void OpenCell(int startR, int startC)
        {
            if (!buttons[startR, startC].Enabled) return;

            Queue<Point> queue = new Queue<Point>();
            queue.Enqueue(new Point(startR, startC));

            while (queue.Count > 0)
            {
                Point p = queue.Dequeue();
                int r = p.X;
                int c = p.Y;

                if (r < 0 || r >= gridSize || c < 0 || c >= gridSize) continue;
                if (!buttons[r, c].Enabled) continue;

                buttons[r, c].Enabled = false;
                buttons[r, c].BackColor = Color.FromArgb(200, 200, 200); 
                buttons[r, c].FlatAppearance.BorderSize = 0;
                openedCells++;

                int count = CountMines(r, c);

                if (count > 0)
                {
                    buttons[r, c].Text = count.ToString();
                    buttons[r, c].ForeColor = GetNumberColor(count);
                }
                else
                {
                    for (int i = -1; i <= 1; i++)
                    {
                        for (int j = -1; j <= 1; j++)
                        {
                            if (i == 0 && j == 0) continue;
                            int nr = r + i;
                            int nc = c + j;
                            if (nr >= 0 && nr < gridSize && nc >= 0 && nc < gridSize)
                            {
                                if (buttons[nr, nc].Enabled && buttons[nr, nc].Text != "ðŸš©")
                                    queue.Enqueue(new Point(nr, nc));
                            }
                        }
                    }
                }
            }
        }

        int CountMines(int r, int c)
        {
            int count = 0;
            for (int i = -1; i <= 1; i++)
            {
                for (int j = -1; j <= 1; j++)
                {
                    int nr = r + i;
                    int nc = c + j;
                    if (nr >= 0 && nr < gridSize && nc >= 0 && nc < gridSize)
                    {
                        if (mines[nr, nc]) count++;
                    }
                }
            }
            return count;
        }

        Color GetNumberColor(int n)
        {
            return n switch
            {
                1 => Color.Blue,
                2 => Color.Green,
                3 => Color.Red,
                4 => Color.DarkBlue,
                5 => Color.DarkRed,
                6 => Color.Teal,
                _ => Color.Black
            };
        }

        void ShowAllMines()
        {
            for (int i = 0; i < gridSize; i++)
            {
                for (int j = 0; j < gridSize; j++)
                {
                    if (mines[i, j])
                    {
                        buttons[i, j].Text = "ðŸ’£";
                        buttons[i, j].ForeColor = Color.Black;
                        if (buttons[i, j].BackColor != Color.Red) 
                            buttons[i, j].BackColor = Color.LightCoral;
                    }
                }
            }
        }

        void ClearGrid()
        {
            if (buttons == null) return;
            foreach (var btn in buttons)
            {
                if (btn != null)
                {
                    Controls.Remove(btn);
                    btn.Dispose();
                }
            }
            buttons = null!;
        }

        void GameOver(bool win)
        {
            gameTimer.Stop();
            MessageBox.Show(win ? $"Tebrikler! KazandÄ±nÄ±z.\nSÃ¼re: {time} saniye" : "Oyun Bitti! Kaybettiniz.");
        }
    }
}
